<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>就活企業管理＋カレンダー</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 900px; margin: auto; }
    li { padding: 10px; margin-bottom: 10px; border-radius: 8px; list-style: none; }
    input, select, textarea { width: 100%; margin-bottom: 10px; }
    .hidden { display: none; }
    .date-field-row { display: flex; gap: 5px; align-items: center; margin-bottom: 8px; }
    .date-field-row input[type="text"] { flex: 2; }
    .date-field-row input[type="date"] { flex: 3; }
  </style>
</head>
<body>
  <h1>就活企業管理＋カレンダー</h1>
  <button id="loginButton">Googleでログイン</button>
  <button id="logoutButton" style="display:none;">ログアウト</button>
  <p id="userEmail"></p>

  <div id="authContent" class="hidden">
    <form id="jobForm">
      <input type="hidden" id="editIndex" value="">
      <label>企業名: <input type="text" id="company" required></label>
      <label>業界: <input type="text" id="industry"></label>
      <label>選考状況:
        <select id="status">
          <option value="未応募">未応募</option>
          <option value="エントリー済">エントリー済</option>
          <option value="ES提出">ES提出</option>
          <option value="面接中">面接中</option>
          <option value="内定">内定</option>
        </select>
      </label>
      <label>志望度（1〜5）: <input type="number" id="priority" min="1" max="5"></label>
      <label>メモ: <textarea id="note" rows="4"></textarea></label>
      <h3>日付項目</h3>
      <div id="customDates"></div>
      <button type="button" onclick="addDateField()">＋ 日付項目を追加</button>
      <button type="submit">登録</button>
    </form>

    <h2>登録一覧</h2>
    <select id="filterStatus">
      <option value="すべて">すべて</option>
      <option value="未応募">未応募</option>
      <option value="エントリー済">エントリー済</option>
      <option value="ES提出">ES提出</option>
      <option value="面接中">面接中</option>
      <option value="内定">内定</option>
    </select>
    <ul id="companyList"></ul>

    <h2>カレンダー</h2>
    <div id='calendar'></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCtJkRR9KiHCI9cmeHd3U6GAKFuUKKnkD8",
      authDomain: "syukatsukanri-cad68.firebaseapp.com",
      projectId: "syukatsukanri-cad68",
      storageBucket: "syukatsukanri-cad68.appspot.com",
      messagingSenderId: "352899195655",
      appId: "1:352899195655:web:3c24fe149735c123655ba2",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const loginBtn = document.getElementById("loginButton");
    const logoutBtn = document.getElementById("logoutButton");
    const authContent = document.getElementById("authContent");
    const userEmail = document.getElementById("userEmail");
    let companies = [];
    let currentUser = null;
    let calendar;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        authContent.classList.remove("hidden");
        userEmail.textContent = `ログイン中: ${user.email}`;
        loadCompanies();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        authContent.classList.add("hidden");
        userEmail.textContent = "";
      }
    });

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(alert);
    };
    logoutBtn.onclick = () => auth.signOut();

    function addDateField(name = '', date = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'date-field-row';
      wrapper.innerHTML = `
        <input type="text" placeholder="項目名" value="${name}" class="dateLabel">
        <input type="date" value="${date}" class="dateValue">
        <button type="button" onclick="this.parentElement.remove()">❌</button>
      `;
      document.getElementById('customDates').appendChild(wrapper);
    }

    function getCustomDates() {
      return Array.from(document.querySelectorAll('.date-field-row')).map(row => ({
        label: row.querySelector('.dateLabel').value,
        date: row.querySelector('.dateValue').value
      })).filter(d => d.label);
    }

    function loadCompanies() {
      db.collection("users").doc(currentUser.uid).collection("jobs").get().then(snapshot => {
        companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayCompanies();
        renderCalendar();
      });
    }

    function saveCompany(entry, id = null) {
      const ref = db.collection("users").doc(currentUser.uid).collection("jobs");
      if (id) ref.doc(id).set(entry).then(loadCompanies);
      else ref.add(entry).then(loadCompanies);
    }

    function displayCompanies() {
      const list = document.getElementById('companyList');
      list.innerHTML = '';
      const filter = document.getElementById('filterStatus').value;
      companies.filter(c => filter === 'すべて' || c.status === filter).forEach(c => {
        const li = document.createElement('li');
        let customDateList = '';
        (c.customDates || []).forEach(d => customDateList += `${d.label}: ${d.date || '未定'}<br>`);
        li.innerHTML = `<strong>${c.company}</strong> - ${c.status}<br>${customDateList}`;
        list.appendChild(li);
      });
    }

    function renderCalendar() {
      const calendarEl = document.getElementById('calendar');
      if (calendar) calendar.destroy();
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        events: companies.flatMap(c => (c.customDates || []).map(d => ({
          title: `${d.label} - ${c.company}`,
          date: d.date,
          color: d.label.includes("締切") ? 'red' : d.label.includes("面接") ? 'blue' : 'green'
        })))
      });
      calendar.render();
    }

    document.getElementById('jobForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('editIndex').value;
      const entry = {
        company: document.getElementById('company').value,
        industry: document.getElementById('industry').value,
        status: document.getElementById('status').value,
        priority: document.getElementById('priority').value,
        note: document.getElementById('note').value,
        customDates: getCustomDates()
      };
      saveCompany(entry, id || null);
      this.reset();
      document.getElementById('customDates').innerHTML = '';
    });

    document.getElementById('filterStatus').addEventListener('change', displayCompanies);
  </script>
</body>
</html>
