<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>就活企業管理アプリ</title>
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
    li { padding: 10px; margin-bottom: 10px; border-radius: 8px; list-style: none; }
    button { margin-right: 6px; }
    input, select, textarea { width: 100%; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>就活企業管理</h1>
  <button id="loginButton">Googleでログイン</button>
  <button id="logoutButton" style="display:none;">ログアウト</button>
  <p id="userEmail"></p>

  <form id="jobForm" style="display:none;">
    <input type="hidden" id="editIndex" value="">
    <label>企業名: <input type="text" id="company" required></label>
    <label>業界: <input type="text" id="industry"></label>
    <label>選考状況:
      <select id="status">
        <option value="未応募">未応募</option>
        <option value="エントリー済">エントリー済</option>
        <option value="ES提出">ES提出</option>
        <option value="面接中">面接中</option>
        <option value="内定">内定</option>
      </select>
    </label>
    <label>志望度（1〜5）: <input type="number" id="priority" min="1" max="5"></label>
    <label>面接日: <input type="date" id="interviewDate"></label>
    <label>締切日: <input type="date" id="deadlineDate"></label>
    <label>メモ: <textarea id="note" rows="4"></textarea></label>
    <button type="submit">登録</button>
  </form>

  <h2>登録一覧</h2>
  <select id="filterStatus">
    <option value="すべて">すべて</option>
    <option value="未応募">未応募</option>
    <option value="エントリー済">エントリー済</option>
    <option value="ES提出">ES提出</option>
    <option value="面接中">面接中</option>
    <option value="内定">内定</option>
  </select>
  <ul id="companyList"></ul>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCtJkRR9KiHCI9cmeHd3U6GAKFuUKKnkD8",
      authDomain: "syukatsukanri-cad68.firebaseapp.com",
      projectId: "syukatsukanri-cad68",
      storageBucket: "syukatsukanri-cad68.appspot.com",
      messagingSenderId: "352899195655",
      appId: "1:352899195655:web:3c24fe149735c123655ba2",
      measurementId: "G-TRXF8QEDHB"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginBtn = document.getElementById("loginButton");
    const logoutBtn = document.getElementById("logoutButton");
    const jobForm = document.getElementById("jobForm");
    const userEmail = document.getElementById("userEmail");
    let companies = [];
    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        jobForm.style.display = "block";
        userEmail.textContent = `ログイン中: ${user.email}`;
        loadCompanies();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        jobForm.style.display = "none";
        userEmail.textContent = "";
        document.getElementById("companyList").innerHTML = "";
      }
    });

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(alert);
    };

    logoutBtn.onclick = () => auth.signOut();

    function loadCompanies() {
      db.collection("users").doc(currentUser.uid).collection("jobs").get().then(snapshot => {
        companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayCompanies();
      });
    }

    function saveCompany(entry, id = null) {
      const ref = db.collection("users").doc(currentUser.uid).collection("jobs");
      if (id) {
        ref.doc(id).set(entry).then(loadCompanies);
      } else {
        ref.add(entry).then(loadCompanies);
      }
    }

    function deleteCompany(id) {
      if (confirm("本当に削除しますか？")) {
        db.collection("users").doc(currentUser.uid).collection("jobs").doc(id).delete().then(loadCompanies);
      }
    }

    function displayCompanies() {
      const list = document.getElementById('companyList');
      list.innerHTML = '';
      const today = new Date();
      const filter = document.getElementById('filterStatus').value;

      companies
        .filter(c => filter === 'すべて' || c.status === filter)
        .sort((a, b) => new Date(a.deadlineDate || 3000) - new Date(b.deadlineDate || 3000))
        .forEach((c) => {
          const li = document.createElement('li');
          let bgColor = 'transparent';
          if (c.deadlineDate) {
            const diffDays = Math.floor((new Date(c.deadlineDate) - today) / (1000 * 60 * 60 * 24));
            if (diffDays <= 3) bgColor = 'rgba(255, 0, 0, 0.4)';
            else if (diffDays <= 7) bgColor = 'rgba(255, 165, 0, 0.3)';
          }
          li.style.backgroundColor = bgColor;

          const calendarLink = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(c.company + '（' + c.status + '）')}&dates=${formatDateForGoogle(c.deadlineDate)}&details=${encodeURIComponent(c.note)}`;

          li.innerHTML = `
            <strong>${c.company}</strong> (${c.industry}) - 状況: ${c.status}, 志望度: ${c.priority}<br>
            面接日: ${c.interviewDate || '未定'}　締切: ${c.deadlineDate || '未定'}<br>
            メモ: ${c.note}<br>
            <button onclick="editCompany('${c.id}')">編集</button>
            <a href="${calendarLink}" target="_blank">📅 カレンダーに追加</a>
            <button onclick="deleteCompany('${c.id}')">削除</button>
          `;
          list.appendChild(li);
        });
    }

    function formatDateForGoogle(date) {
      if (!date) return '';
      const d = new Date(date);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}${mm}${dd}/${yyyy}${mm}${dd}`;
    }

    function editCompany(id) {
      const c = companies.find(e => e.id === id);
      document.getElementById('company').value = c.company;
      document.getElementById('industry').value = c.industry;
      document.getElementById('status').value = c.status;
      document.getElementById('priority').value = c.priority;
      document.getElementById('interviewDate').value = c.interviewDate;
      document.getElementById('deadlineDate').value = c.deadlineDate;
      document.getElementById('note').value = c.note;
      document.getElementById('editIndex').value = id;
    }

    document.getElementById('jobForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('editIndex').value;
      const entry = {
        company: document.getElementById('company').value,
        industry: document.getElementById('industry').value,
        status: document.getElementById('status').value,
        priority: document.getElementById('priority').value,
        interviewDate: document.getElementById('interviewDate').value,
        deadlineDate: document.getElementById('deadlineDate').value,
        note: document.getElementById('note').value
      };
      saveCompany(entry, id || null);
      this.reset();
      document.getElementById('editIndex').value = '';
    }

    `)`                                                    
    function signIn() {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider)
    .then((result) => {
      console.log("ログイン成功:", result.user);
    })
    .catch((error) => {
      console.error("ログイン失敗:", error);
    });
});

    document.getElementById('filterStatus').addEventListener('change', displayCompanies);
  </script>
</body>
</html>
