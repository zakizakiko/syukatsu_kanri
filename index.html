<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°±æ´»ä¼æ¥­ç®¡ç†ã‚¢ãƒ—ãƒª</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 800px; margin: auto; }
    li { padding: 10px; margin-bottom: 10px; border-radius: 8px; list-style: none; }
    button { margin-right: 6px; }
    input, select, textarea { width: 100%; margin-bottom: 10px; }
    .hidden { display: none; }
    .date-field-row { display: flex; gap: 5px; align-items: center; margin-bottom: 8px; }
    .date-field-row input[type="text"] { flex: 2; }
    .date-field-row input[type="date"] { flex: 3; }
  </style>
</head>
<body>
  <h1>å°±æ´»ä¼æ¥­ç®¡ç†</h1>
  <button id="loginButton">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button id="logoutButton" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <p id="userEmail"></p>

  <div id="authContent" class="hidden">
    <form id="jobForm">
      <input type="hidden" id="editIndex" value="">
      <label>ä¼æ¥­å: <input type="text" id="company" required></label>
      <label>æ¥­ç•Œ: <input type="text" id="industry"></label>
      <label>é¸è€ƒçŠ¶æ³:
        <select id="status">
          <option value="æœªå¿œå‹Ÿ">æœªå¿œå‹Ÿ</option>
          <option value="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ">ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ</option>
          <option value="ESæå‡º">ESæå‡º</option>
          <option value="é¢æ¥ä¸­">é¢æ¥ä¸­</option>
          <option value="å†…å®š">å†…å®š</option>
        </select>
      </label>
      <label>å¿—æœ›åº¦ï¼ˆ1ã€œ5ï¼‰: <input type="number" id="priority" min="1" max="5"></label>
      <label>ãƒ¡ãƒ¢: <textarea id="note" rows="4"></textarea></label>
      <h3>æ—¥ä»˜é …ç›®</h3>
      <div id="customDates"></div>
      <button type="button" onclick="addDateField()">ï¼‹ æ—¥ä»˜é …ç›®ã‚’è¿½åŠ </button>
      <button type="submit">ç™»éŒ²</button>
    </form>

    <h2>ç™»éŒ²ä¸€è¦§</h2>
    <label>ä¼æ¥­åã§æ¤œç´¢: <input type="text" id="searchKeyword" placeholder="ä¾‹ï¼šãƒˆãƒ¨ã‚¿ã€é›»é€šãªã©"></label>
    <select id="filterStatus">
      <option value="ã™ã¹ã¦">ã™ã¹ã¦</option>
      <option value="æœªå¿œå‹Ÿ">æœªå¿œå‹Ÿ</option>
      <option value="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ">ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ</option>
      <option value="ESæå‡º">ESæå‡º</option>
      <option value="é¢æ¥ä¸­">é¢æ¥ä¸­</option>
      <option value="å†…å®š">å†…å®š</option>
    </select>
    <ul id="companyList"></ul>

    <h2>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div id="calendar" style="margin-top: 20px; height: 600px;"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCtJkRR9KiHCI9cmeHd3U6GAKFuUKKnkD8",
      authDomain: "syukatsukanri-cad68.firebaseapp.com",
      projectId: "syukatsukanri-cad68",
      storageBucket: "syukatsukanri-cad68.appspot.com",
      messagingSenderId: "352899195655",
      appId: "1:352899195655:web:3c24fe149735c123655ba2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginBtn = document.getElementById("loginButton");
    const logoutBtn = document.getElementById("logoutButton");
    const userEmail = document.getElementById("userEmail");
    const authContent = document.getElementById("authContent");
    let companies = [];
    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        authContent.classList.remove("hidden");
        userEmail.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}`;
        loadCompanies();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        authContent.classList.add("hidden");
        userEmail.textContent = "";
      }
    });

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(alert);
    };

    logoutBtn.onclick = () => auth.signOut();

    function addDateField(name = '', date = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'date-field-row';
      wrapper.innerHTML = `
        <input type="text" placeholder="é …ç›®å" value="${name}" class="dateLabel">
        <input type="date" value="${date}" class="dateValue">
        <button type="button" onclick="this.parentElement.remove()">âŒ</button>
      `;
      document.getElementById('customDates').appendChild(wrapper);
    }

    function getCustomDates() {
      return Array.from(document.querySelectorAll('.date-field-row')).map(row => ({
        label: row.querySelector('.dateLabel').value,
        date: row.querySelector('.dateValue').value
      })).filter(d => d.label);
    }

    function loadCompanies() {
      db.collection("users").doc(currentUser.uid).collection("jobs").get().then(snapshot => {
        companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayCompanies();
      });
    }

    function saveCompany(entry, id = null) {
      const ref = db.collection("users").doc(currentUser.uid).collection("jobs");
      if (id) {
        ref.doc(id).set(entry).then(loadCompanies);
      } else {
        ref.add(entry).then(loadCompanies);
      }
    }

    function deleteCompany(id) {
      if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        db.collection("users").doc(currentUser.uid).collection("jobs").doc(id).delete().then(loadCompanies);
      }
    }

   ã€€ã€€function displayCompanies() {
  const list = document.getElementById('companyList');
  list.innerHTML = '';
  const today = new Date();
  const filter = document.getElementById('filterStatus').value;
  const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase(); // ğŸ”æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰

  const events = [];

  const sorted = companies
    .filter(c =>
      (filter === 'ã™ã¹ã¦' || c.status === filter) &&
      (!keyword || c.company.toLowerCase().includes(keyword)) // ğŸ”åå‰ä¸€è‡´
    )
    .map(c => {
      const upcomingDates = (c.customDates || []).map(d => {
        const date = new Date(d.date);
        const diff = Math.floor((date - today) / (1000 * 60 * 60 * 24));
        return (!isNaN(date) && diff >= 0) ? diff : Infinity;
      });
      const nearest = Math.min(...upcomingDates);
      return { ...c, nearestDate: nearest };
    })
    .sort((a, b) => a.nearestDate - b.nearestDate);

  sorted.forEach(c => {
    const li = document.createElement('li');
    let customDateList = '';

    (c.customDates || []).forEach(d => {
      const date = new Date(d.date);
      const diffDays = Math.floor((date - today) / (1000 * 60 * 60 * 24));
      let bgColor = '';

      if (!isNaN(date) && diffDays >= 0) {
        if (diffDays <= 1) bgColor = '#ffcccc';
        else if (diffDays <= 3) bgColor = '#ffe0b3';
        else if (diffDays <= 6) bgColor = '#ffffcc';
        else if (diffDays <= 14) bgColor = '#ccffcc';
      }

      customDateList += `<span style="background-color:${bgColor}; padding:2px 4px; border-radius:4px;">${d.label}: ${d.date}</span><br>`;

      if (d.date) {
        events.push({
          title: `${c.company} - ${d.label}`,
          start: d.date,
          extendedProps: {
            company: c.company,
            label: d.label,
            status: c.status,
            note: c.note
          }
        });
      }
    });

    li.innerHTML = `
      <strong>${c.company}</strong> (${c.industry}) - çŠ¶æ³: ${c.status}, å¿—æœ›åº¦: ${c.priority}<br>
      ${customDateList}
      ãƒ¡ãƒ¢: ${c.note}<br>
      <button onclick="editCompany('${c.id}')">ç·¨é›†</button>
      <button onclick="deleteCompany('${c.id}')">å‰Šé™¤</button>
    `;
    list.appendChild(li);
  });

  renderCalendar(events);
}

    function renderCalendar(events) {
      const calendarEl = document.getElementById('calendar');
      calendarEl.innerHTML = '';
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 600,
        events: events,
        eventClick: function(info) {
          const { company, label, status, note } = info.event.extendedProps;
          alert(`ä¼æ¥­: ${company}\né …ç›®: ${label}\nçŠ¶æ³: ${status}\nãƒ¡ãƒ¢: ${note || 'ãªã—'}`);
        }
      });
      calendar.render();
    }

    function editCompany(id) {
      const c = companies.find(e => e.id === id);
      document.getElementById('company').value = c.company;
      document.getElementById('industry').value = c.industry;
      document.getElementById('status').value = c.status;
      document.getElementById('priority').value = c.priority;
      document.getElementById('note').value = c.note;
      document.getElementById('editIndex').value = id;
      document.getElementById('customDates').innerHTML = '';
      (c.customDates || []).forEach(d => addDateField(d.label, d.date));
    }

    document.getElementById('jobForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('editIndex').value;
      const entry = {
        company: document.getElementById('company').value,
        industry: document.getElementById('industry').value,
        status: document.getElementById('status').value,
        priority: document.getElementById('priority').value,
        note: document.getElementById('note').value,
        customDates: getCustomDates()
      };
      saveCompany(entry, id || null);
      this.reset();
      document.getElementById('editIndex').value = '';
      document.getElementById('customDates').innerHTML = '';
    });

    document.getElementById('filterStatus').addEventListener('change', displayCompanies);
  </script>
</body>
</html>
