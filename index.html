<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°±æ´»ä¼æ¥­ç®¡ç†ã‚¢ãƒ—ãƒª</title>
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
    li { padding: 10px; margin-bottom: 10px; border-radius: 8px; list-style: none; }
    button { margin-right: 6px; }
    input, select, textarea { width: 100%; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>å°±æ´»ä¼æ¥­ç®¡ç†</h1>
  <button id="loginButton">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button id="logoutButton" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <p id="userEmail"></p>

  <form id="jobForm" style="display:none;">
    <input type="hidden" id="editIndex" value="">
    <label>ä¼æ¥­å: <input type="text" id="company" required></label>
    <label>æ¥­ç•Œ: <input type="text" id="industry"></label>
    <label>é¸è€ƒçŠ¶æ³:
      <select id="status">
        <option value="æœªå¿œå‹Ÿ">æœªå¿œå‹Ÿ</option>
        <option value="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ">ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ</option>
        <option value="ESæå‡º">ESæå‡º</option>
        <option value="é¢æ¥ä¸­">é¢æ¥ä¸­</option>
        <option value="å†…å®š">å†…å®š</option>
      </select>
    </label>
    <label>å¿—æœ›åº¦ï¼ˆ1ã€œ5ï¼‰: <input type="number" id="priority" min="1" max="5"></label>
    <label>é¢æ¥æ—¥: <input type="date" id="interviewDate"></label>
    <label>ç· åˆ‡æ—¥: <input type="date" id="deadlineDate"></label>
    <label>ãƒ¡ãƒ¢: <textarea id="note" rows="4"></textarea></label>
    <button type="submit">ç™»éŒ²</button>
  </form>

  <h2>ç™»éŒ²ä¸€è¦§</h2>
  <select id="filterStatus">
    <option value="ã™ã¹ã¦">ã™ã¹ã¦</option>
    <option value="æœªå¿œå‹Ÿ">æœªå¿œå‹Ÿ</option>
    <option value="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ">ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¸ˆ</option>
    <option value="ESæå‡º">ESæå‡º</option>
    <option value="é¢æ¥ä¸­">é¢æ¥ä¸­</option>
    <option value="å†…å®š">å†…å®š</option>
  </select>
  <ul id="companyList"></ul>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCtJkRR9KiHCI9cmeHd3U6GAKFuUKKnkD8",
      authDomain: "syukatsukanri-cad68.firebaseapp.com",
      projectId: "syukatsukanri-cad68",
      storageBucket: "syukatsukanri-cad68.appspot.com",
      messagingSenderId: "352899195655",
      appId: "1:352899195655:web:3c24fe149735c123655ba2",
      measurementId: "G-TRXF8QEDHB"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginBtn = document.getElementById("loginButton");
    const logoutBtn = document.getElementById("logoutButton");
    const jobForm = document.getElementById("jobForm");
    const userEmail = document.getElementById("userEmail");
    let companies = [];
    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        jobForm.style.display = "block";
        userEmail.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.email}`;
        loadCompanies();
      } else {
        currentUser = null;
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        jobForm.style.display = "none";
        userEmail.textContent = "";
        document.getElementById("companyList").innerHTML = "";
      }
    });

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(alert);
    };

    logoutBtn.onclick = () => auth.signOut();

    function loadCompanies() {
      db.collection("users").doc(currentUser.uid).collection("jobs").get().then(snapshot => {
        companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayCompanies();
      });
    }

    function saveCompany(entry, id = null) {
      const ref = db.collection("users").doc(currentUser.uid).collection("jobs");
      if (id) {
        ref.doc(id).set(entry).then(loadCompanies);
      } else {
        ref.add(entry).then(loadCompanies);
      }
    }

    function deleteCompany(id) {
      if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        db.collection("users").doc(currentUser.uid).collection("jobs").doc(id).delete().then(loadCompanies);
      }
    }

    function displayCompanies() {
      const list = document.getElementById('companyList');
      list.innerHTML = '';
      const today = new Date();
      const filter = document.getElementById('filterStatus').value;

      companies
        .filter(c => filter === 'ã™ã¹ã¦' || c.status === filter)
        .sort((a, b) => new Date(a.deadlineDate || 3000) - new Date(b.deadlineDate || 3000))
        .forEach((c) => {
          const li = document.createElement('li');
          let bgColor = 'transparent';
          if (c.deadlineDate) {
            const diffDays = Math.floor((new Date(c.deadlineDate) - today) / (1000 * 60 * 60 * 24));
            if (diffDays <= 3) bgColor = 'rgba(255, 0, 0, 0.4)';
            else if (diffDays <= 7) bgColor = 'rgba(255, 165, 0, 0.3)';
          }
          li.style.backgroundColor = bgColor;

          const calendarLink = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(c.company + 'ï¼ˆ' + c.status + 'ï¼‰')}&dates=${formatDateForGoogle(c.deadlineDate)}&details=${encodeURIComponent(c.note)}`;

          li.innerHTML = `
            <strong>${c.company}</strong> (${c.industry}) - çŠ¶æ³: ${c.status}, å¿—æœ›åº¦: ${c.priority}<br>
            é¢æ¥æ—¥: ${c.interviewDate || 'æœªå®š'}ã€€ç· åˆ‡: ${c.deadlineDate || 'æœªå®š'}<br>
            ãƒ¡ãƒ¢: ${c.note}<br>
            <button onclick="editCompany('${c.id}')">ç·¨é›†</button>
            <a href="${calendarLink}" target="_blank">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¿½åŠ </a>
            <button onclick="deleteCompany('${c.id}')">å‰Šé™¤</button>
          `;
          list.appendChild(li);
        });
    }

    function formatDateForGoogle(date) {
      if (!date) return '';
      const d = new Date(date);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}${mm}${dd}/${yyyy}${mm}${dd}`;
    }

    function editCompany(id) {
      const c = companies.find(e => e.id === id);
      document.getElementById('company').value = c.company;
      document.getElementById('industry').value = c.industry;
      document.getElementById('status').value = c.status;
      document.getElementById('priority').value = c.priority;
      document.getElementById('interviewDate').value = c.interviewDate;
      document.getElementById('deadlineDate').value = c.deadlineDate;
      document.getElementById('note').value = c.note;
      document.getElementById('editIndex').value = id;
    }

    document.getElementById('jobForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('editIndex').value;
      const entry = {
        company: document.getElementById('company').value,
        industry: document.getElementById('industry').value,
        status: document.getElementById('status').value,
        priority: document.getElementById('priority').value,
        interviewDate: document.getElementById('interviewDate').value,
        deadlineDate: document.getElementById('deadlineDate').value,
        note: document.getElementById('note').value
      };
      saveCompany(entry, id || null);
      this.reset();
      document.getElementById('editIndex').value = '';
    }

    `)`                                                    
    function signIn() {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider)
    .then((result) => {
      console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:", result.user);
    })
    .catch((error) => {
      console.error("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:", error);
    });
});

    document.getElementById('filterStatus').addEventListener('change', displayCompanies);
  </script>
</body>
</html>
